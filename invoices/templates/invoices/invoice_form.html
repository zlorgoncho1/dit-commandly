{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ title }} - Factures - Commandly{% endblock %}

{% block extra_css %}
<style>
    .form-header {
        background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
        color: white;
        border-radius: 10px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    .form-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-left: 4px solid #6f42c1;
    }
    .form-section h5 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 1rem;
    }
    .required-field {
        color: #dc3545;
    }
    .form-control:focus, .form-select:focus {
        border-color: #6f42c1;
        box-shadow: 0 0 0 0.2rem rgba(111, 66, 193, 0.25);
    }
    .btn-purple {
        background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
        border: none;
        color: white;
    }
    .btn-purple:hover {
        background: linear-gradient(135deg, #5a32a3 0%, #c73078 100%);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête -->
    <div class="form-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h3 mb-1">
                    <i class="bi bi-{% if invoice %}pencil{% else %}plus-circle{% endif %}"></i>
                    {{ title }}
                </h1>
                <p class="mb-0 opacity-75">
                    {% if invoice %}
                        Modifiez les informations de la facture
                    {% else %}
                        Créez une nouvelle facture
                    {% endif %}
                </p>
            </div>
            <div class="col-md-4 text-end">
                <a href="{% if invoice %}{% url 'invoices:invoice_detail' invoice.pk %}{% else %}{% url 'invoices:invoice_list' %}{% endif %}" 
                   class="btn btn-outline-light">
                    <i class="bi bi-arrow-left"></i> Retour
                </a>
            </div>
        </div>
    </div>

    <form method="post" novalidate>
        {% csrf_token %}
        
        <div class="row">
            <div class="col-lg-8">
                <!-- Informations de base -->
                <div class="form-section">
                    <h5>
                        <i class="bi bi-info-circle text-purple"></i>
                        Informations de base
                    </h5>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.customer.id_for_label }}" class="form-label">
                                {{ form.customer.label }}
                                <span class="required-field">*</span>
                            </label>
                            {{ form.customer }}
                            {% if form.customer.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.customer.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                <a href="{% url 'customers:customer_create' %}" target="_blank">
                                    <i class="bi bi-plus-circle"></i> Créer un nouveau client
                                </a>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.order.id_for_label }}" class="form-label">
                                {{ form.order.label }}
                            </label>
                            {{ form.order }}
                            {% if form.order.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.order.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">Commande associée (optionnel)</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.invoice_date.id_for_label }}" class="form-label">
                                {{ form.invoice_date.label }}
                                <span class="required-field">*</span>
                            </label>
                            {{ form.invoice_date }}
                            {% if form.invoice_date.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.invoice_date.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.due_date.id_for_label }}" class="form-label">
                                {{ form.due_date.label }}
                                <span class="required-field">*</span>
                            </label>
                            {{ form.due_date }}
                            {% if form.due_date.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.due_date.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.status.id_for_label }}" class="form-label">
                                {{ form.status.label }}
                                <span class="required-field">*</span>
                            </label>
                            {{ form.status }}
                            {% if form.status.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.status.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Montants -->
                <div class="form-section">
                    <h5>
                        <i class="bi bi-calculator text-purple"></i>
                        Montants
                    </h5>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.subtotal_ht.id_for_label }}" class="form-label">
                                {{ form.subtotal_ht.label }}
                                <span class="required-field">*</span>
                            </label>
                            <div class="input-group">
                                {{ form.subtotal_ht }}
                                <span class="input-group-text">FCFA</span>
                            </div>
                            {% if form.subtotal_ht.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.subtotal_ht.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">Montant hors taxes</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.tax_amount.id_for_label }}" class="form-label">
                                {{ form.tax_amount.label }}
                            </label>
                            <div class="input-group">
                                {{ form.tax_amount }}
                                <span class="input-group-text">FCFA</span>
                            </div>
                            {% if form.tax_amount.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.tax_amount.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">Montant de la TVA</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.total_amount.id_for_label }}" class="form-label">
                                {{ form.total_amount.label }}
                                <span class="required-field">*</span>
                            </label>
                            <div class="input-group">
                                {{ form.total_amount }}
                                <span class="input-group-text">FCFA</span>
                            </div>
                            {% if form.total_amount.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.total_amount.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">Montant total TTC</div>
                        </div>
                    </div>

                    <!-- Calcul automatique -->
                    <div class="alert alert-info">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Sous-total HT :</strong><br>
                                <span id="calc-subtotal-ht" class="text-primary">0 FCFA</span>
                            </div>
                            <div class="col-md-4">
                                <strong>TVA :</strong><br>
                                <span id="calc-tax" class="text-warning">0 FCFA</span>
                            </div>
                            <div class="col-md-4">
                                <strong>Total TTC :</strong><br>
                                <span id="calc-total" class="h6 text-success">0 FCFA</span>
                            </div>
                        </div>
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            Le total TTC est calculé automatiquement : Sous-total HT + TVA
                        </small>
                    </div>
                </div>

                <!-- Notes -->
                <div class="form-section">
                    <h5>
                        <i class="bi bi-chat-text text-purple"></i>
                        Notes et commentaires
                    </h5>
                    
                    <div class="mb-3">
                        <label for="{{ form.notes.id_for_label }}" class="form-label">
                            {{ form.notes.label }}
                        </label>
                        {{ form.notes }}
                        {% if form.notes.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.notes.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">Notes internes ou conditions particulières</div>
                    </div>
                </div>
            </div>

            <!-- Sidebar avec informations supplémentaires -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle text-purple"></i>
                            Informations
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if invoice %}
                            <div class="mb-3">
                                <strong>N° Facture :</strong><br>
                                <code>{{ invoice.invoice_number }}</code>
                            </div>
                            <div class="mb-3">
                                <strong>Créée le :</strong><br>
                                <small class="text-muted">{{ invoice.created_at|date:"d/m/Y à H:i" }}</small>
                            </div>
                            {% if invoice.updated_at != invoice.created_at %}
                                <div class="mb-3">
                                    <strong>Modifiée le :</strong><br>
                                    <small class="text-muted">{{ invoice.updated_at|date:"d/m/Y à H:i" }}</small>
                                </div>
                            {% endif %}
                            
                            <!-- Résumé des paiements -->
                            <hr>
                            <div class="mb-2">
                                <strong>Montant payé :</strong><br>
                                <span class="text-success">{{ invoice.paid_amount|floatformat:0 }} FCFA</span>
                            </div>
                            <div class="mb-2">
                                <strong>Restant dû :</strong><br>
                                <span class="{% if invoice.remaining_amount > 0 %}text-danger{% else %}text-success{% endif %}">
                                    {{ invoice.remaining_amount|floatformat:0 }} FCFA
                                </span>
                            </div>
                            <div class="mb-2">
                                <strong>Nombre de paiements :</strong><br>
                                <span class="badge bg-primary">{{ invoice.payments.count }}</span>
                            </div>
                            
                            {% if invoice.payments.exists %}
                                <div class="mt-3">
                                    <a href="{% url 'invoices:invoice_detail' invoice.pk %}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i> Voir les détails
                                    </a>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="alert alert-info">
                                <small>
                                    <i class="bi bi-info-circle"></i>
                                    Le numéro de facture sera généré automatiquement après création.
                                </small>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Aide -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-question-circle text-info"></i>
                            Aide
                        </h6>
                    </div>
                    <div class="card-body">
                        <small class="text-muted">
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success"></i>
                                    Les champs marqués d'un <span class="required-field">*</span> sont obligatoires
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success"></i>
                                    Le total TTC est calculé automatiquement
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success"></i>
                                    Associer une commande copie automatiquement les montants
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success"></i>
                                    La date d'échéance détermine les rappels de paiement
                                </li>
                            </ul>
                        </small>
                    </div>
                </div>

                <!-- Statuts disponibles -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-flag text-info"></i>
                            Statuts de facture
                        </h6>
                    </div>
                    <div class="card-body">
                        <small class="text-muted">
                            <ul class="list-unstyled mb-0">
                                <li class="mb-1"><span class="badge bg-secondary">En attente</span> - Facture créée</li>
                                <li class="mb-1"><span class="badge bg-success">Payée</span> - Entièrement payée</li>
                                <li class="mb-1"><span class="badge bg-warning">Partiellement payée</span> - Paiement partiel</li>
                                <li class="mb-1"><span class="badge bg-danger">En retard</span> - Échéance dépassée</li>
                            </ul>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Boutons d'action -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="d-flex justify-content-between">
                    <a href="{% if invoice %}{% url 'invoices:invoice_detail' invoice.pk %}{% else %}{% url 'invoices:invoice_list' %}{% endif %}" 
                       class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle"></i> Annuler
                    </a>
                    <button type="submit" class="btn btn-purple btn-lg">
                        <i class="bi bi-check-circle"></i> {{ submit_text }}
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const subtotalHtField = document.getElementById('{{ form.subtotal_ht.id_for_label }}');
        const taxAmountField = document.getElementById('{{ form.tax_amount.id_for_label }}');
        const totalAmountField = document.getElementById('{{ form.total_amount.id_for_label }}');
        const orderField = document.getElementById('{{ form.order.id_for_label }}');
        const dueDateField = document.getElementById('{{ form.due_date.id_for_label }}');
        const invoiceDateField = document.getElementById('{{ form.invoice_date.id_for_label }}');
        
        function updateCalculations() {
            const subtotalHt = parseFloat(subtotalHtField.value) || 0;
            const taxAmount = parseFloat(taxAmountField.value) || 0;
            const totalAmount = subtotalHt + taxAmount;
            
            // Mise à jour du champ total
            totalAmountField.value = totalAmount.toFixed(2);
            
            // Mise à jour de l'affichage
            document.getElementById('calc-subtotal-ht').textContent = `${Math.round(subtotalHt)} FCFA`;
            document.getElementById('calc-tax').textContent = `${Math.round(taxAmount)} FCFA`;
            document.getElementById('calc-total').textContent = `${Math.round(totalAmount)} FCFA`;
        }
        
        function loadOrderData(orderId) {
            if (!orderId) return;
            
            fetch(`{% url 'orders:order_quick_search' %}?q=${orderId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        const order = data.results.find(o => o.id == orderId);
                        if (order) {
                            // Remplir automatiquement les montants depuis la commande
                            if (!subtotalHtField.value) {
                                subtotalHtField.value = order.subtotal_ht || order.total;
                            }
                            if (!totalAmountField.value) {
                                totalAmountField.value = order.total;
                            }
                            updateCalculations();
                        }
                    }
                })
                .catch(error => console.error('Erreur lors du chargement de la commande:', error));
        }
        
        function updateDueDate() {
            if (invoiceDateField.value && !dueDateField.value) {
                // Calculer automatiquement la date d'échéance (30 jours par défaut)
                const invoiceDate = new Date(invoiceDateField.value);
                invoiceDate.setDate(invoiceDate.getDate() + 30);
                dueDateField.value = invoiceDate.toISOString().split('T')[0];
            }
        }
        
        // Événements
        [subtotalHtField, taxAmountField].forEach(field => {
            field.addEventListener('input', updateCalculations);
        });
        
        orderField.addEventListener('change', function() {
            loadOrderData(this.value);
        });
        
        invoiceDateField.addEventListener('change', updateDueDate);
        
        // Calcul initial
        updateCalculations();
        
        // Validation côté client
        const form = document.querySelector('form');
        form.addEventListener('submit', function(e) {
            let isValid = true;
            const requiredFields = form.querySelectorAll('[required]');
            
            requiredFields.forEach(function(field) {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            // Validation des montants
            if (subtotalHtField.value && parseFloat(subtotalHtField.value) < 0) {
                subtotalHtField.classList.add('is-invalid');
                isValid = false;
            }
            
            if (totalAmountField.value && parseFloat(totalAmountField.value) <= 0) {
                totalAmountField.classList.add('is-invalid');
                isValid = false;
            }
            
            // Validation des dates
            if (invoiceDateField.value && dueDateField.value) {
                const invoiceDate = new Date(invoiceDateField.value);
                const dueDate = new Date(dueDateField.value);
                if (dueDate < invoiceDate) {
                    dueDateField.classList.add('is-invalid');
                    isValid = false;
                    alert('La date d\'échéance ne peut pas être antérieure à la date de facture');
                }
            }
            
            if (!isValid) {
                e.preventDefault();
                alert('Veuillez corriger les erreurs dans le formulaire');
            }
        });
        
        // Auto-formatage des champs numériques
        [subtotalHtField, taxAmountField, totalAmountField].forEach(function(field) {
            if (field) {
                field.addEventListener('input', function(e) {
                    // Supprimer les caractères non numériques (sauf le point décimal)
                    let value = e.target.value.replace(/[^0-9.]/g, '');
                    // S'assurer qu'il n'y a qu'un seul point décimal
                    const parts = value.split('.');
                    if (parts.length > 2) {
                        value = parts[0] + '.' + parts.slice(1).join('');
                    }
                    e.target.value = value;
                });
            }
        });
    });
</script>
{% endblock %}
